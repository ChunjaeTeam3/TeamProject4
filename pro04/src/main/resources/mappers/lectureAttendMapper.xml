<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ed.haebeop.persistence.LectureAttendMapper">

    <select id="attendListTeacher" resultType="kr.ed.haebeop.domain.LectureAttendVO">
        SELECT r.lcode as lcode, u.id as id, name, adate, atime, atype
        FROM register r LEFT OUTER JOIN lectureAttend l ON (r.lcode=l.lcode AND r.id=l.id) JOIN user u ON (r.id=u.id)
        WHERE r.lcode=#{lcode} AND adate=CURRENT_DATE ORDER BY name
    </select>

    <insert id="insertAttend">
        INSERT INTO lectureattend VALUES
        <foreach collection="dataArray" item="item" separator=" , ">
            (#{item.id}, #{item.lcode}, default, #{item.atime}, #{item.atype})
        </foreach>
        ON DUPLICATE KEY UPDATE atime=values(atime), atype=values(atype)
    </insert>

    <insert id="saveAttendCode">
        <selectKey keyProperty="attendCode" resultType="int" order="AFTER">
            select attendCode from saveattendcode where lcode=#{lcode}
        </selectKey>

        INSERT INTO saveattendcode
        VALUES(#{lcode}, FLOOR(100 + RAND() * 899))
            ON DUPLICATE KEY UPDATE attendCode=FLOOR(100 + RAND() * 899);
        SELECT * FROM saveattendcode;
    </insert>

</mapper>